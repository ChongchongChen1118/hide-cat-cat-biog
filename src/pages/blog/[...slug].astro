---
import { getCollection } from "astro:content";
import PostLayout from "../../layouts/PostLayout.astro";

export async function getStaticPaths() {
  const posts = await getCollection("posts", (p) => !p.data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();
---

<PostLayout frontmatter={post.data}>
  <!-- 文章正文 -->
  <article class="post-content" id="post-content">
    <Content />
  </article>

  <!-- 自动给外链加 target="_blank" -->
  <script type="module">
    const root = document.getElementById("post-content");
    if (root) {
      root.querySelectorAll("a[href]").forEach((a) => {
        const href = a.getAttribute("href");
        if (!href) return;

        // 跳过站内链接 / 锚点 / 邮箱 / 电话
        if (
          href.startsWith("/") ||
          href.startsWith("#") ||
          href.startsWith("mailto:") ||
          href.startsWith("tel:")
        ) {
          return;
        }

        // 只处理真正的外链
        let url;
        try {
          url = new URL(href, window.location.href);
        } catch {
          return;
        }

        // 同源链接不新开（如果你想同源也新开，删掉这行判断）
        if (url.origin === window.location.origin) return;

        a.setAttribute("target", "_blank");
        a.setAttribute("rel", "noopener noreferrer");
      });
    }
  </script>

  <hr />

  <!-- 评论标题 -->
  <div class="small" style="color:var(--muted); margin-bottom: 8px;">
    评论（Giscus）
  </div>

  <!-- Giscus 评论 -->
  <div class="giscus-wrap">
    <script
      src="https://giscus.app/client.js"
      data-repo="ChongchongChen1118/hide-cat-cat-biog"
      data-repo-id="R_kgDOQ6otfg"
      data-category="General"
      data-category-id="DIC_kwDOQ6otfs4C1AUc"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="1"
      data-input-position="bottom"
      data-theme="dark_dimmed"
      data-lang="zh-CN"
      crossorigin="anonymous"
      async>
    </script>
  </div>
<style>
  /* Astro scoped 样式默认命不中 Markdown 生成的标签
     所以这里用 :global 让规则真正生效 */

  :global(.post-content){
    max-width: 100%;
    min-width: 0;
  }

  /* ✅ 超出就自动缩小：只缩大图，不放大小图 */
  :global(.post-content img){
    max-width: 100% !important;
    height: auto !important;
    display: block;
  }

  /* 如果图片外层是 figure/p，也兜住 */
  :global(.post-content figure),
  :global(.post-content p){
    max-width: 100%;
  }

  /* 代码块/表格允许自己横向滚动（不影响图片缩放） */
  :global(.post-content pre){
    max-width: 100%;
    overflow-x: auto;
  }
  :global(.post-content table){
    display: block;
    max-width: 100%;
    overflow-x: auto;
  }
</style>

</PostLayout>